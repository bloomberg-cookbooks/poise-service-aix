#!/bin/sh
# Init script for <%= @name %> generated by poise-service

NAME=<%= @name %>
PIDFILE=<%= @pid_file %>
RUNDIR=<%= @directory %>
ARGUMENTS="<%= @arguments %>"
ENVIRONMENT="<%= @environment.map { |kv| kv.join('=') }.join(' ') %>"

set -e
cd $RUNDIR

case "$1" in
    start)
        startsrc -s $NAME -e "$ENVIRONMENT" -a "$ARGUMENTS"
        if [ $? -eq 0 ]; then
            if [ ! -f $PIDFILE ]; then
                echo "$NAME: failed to start"
                exit 2
            fi

            PID=`cat $PIDFILE 2>/dev/null`
            echo "$NAME: started [$PID]"
        else
            echo "$NAME: failed to start"
            exit 3
        fi
        ;;
    stop)
        if [ -f $PIDFILE ]; then
            PID=`cat $PIDFILE 2>/dev/null`
            stopsrc -c -s $NAME -p $PID
            if [ $? -ne 0 ]; then
                echo "$NAME: failed to stop"
                exit 4
            fi

            echo "$NAME: stopped"
        else
            echo "$NAME: not running"
            exit 1
        fi
        ;;
    restart)
        if [ -f $PIDFILE ]; then
            PID=`cat $PIDFILE 2>/dev/null`
            refresh -s $NAME -p $PID
            if [ $? -ne 0 ]; then
                echo "$NAME: failed to restart"
                exit 5
            fi

            echo "$NAME: restarted"
        fi
        ;;
    status)
        if [ -f $PIDFILE ]; then
            PID=`cat $PIDFILE 2>/dev/null`
            if [ $? -ne 0 ]; then
                rm -f $PIDFILE
                echo "$NAME: not running [$PID]"
            else
                echo "$NAME: running [$PID]"
            fi
        else
            echo "$NAME: not running"
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
